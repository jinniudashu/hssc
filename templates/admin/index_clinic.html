{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" type="text/css" href="{% static "admin/css/dashboard.css" %}">{% endblock %}

{% block coltype %}colMS{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block nav-sidebar %}{% endblock %}

{% block content %}

    <label value="客户">客户：</label> <input class="form-control" type="search" 
    name="search" placeholder="查找客户..." 
    hx-post="search_customers/"
    hx-trigger="keyup changed delay:500ms, search" 
    hx-target="#search-results" 
    hx-indicator=".htmx-indicator">

    <div id="search-results"></div>
    <br>
    <hr>
    <br>

    {% verbatim %}
    <div id="app">
        <div v-for="item in unassignedProcs" :key="item.title">
            <div v-if="item.unassigned_procs.length > 0">
            <h3>{{ item.title }}</h3>
            <br>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">客户姓名</th>
                        <th scope="col">服务项目</th>
                        <th v-if="item.title != '共享服务'" scope="col">计划日期</th>
                        <th scope="col">负责人</th>
                        <th v-if="item.title != '共享服务'" scope="col">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="proc in item.unassigned_procs" :key="proc.id">
                        <td><a :href="'receive_task/' + proc.id">{{ proc.customer_name }}</a></td>
                        <td :class="{'red': proc.acceptance_timeout}">{{ proc.service_label }}</td>
                        <td v-if="item.title != '共享服务'">{{ proc.scheduled_time.split(' ')[0].split('.').slice(1, 3).join('.') }}</td>
                        <td>{{ proc.charge_staff }}</td>
                        <td v-if="item.title != '共享服务'" >
                            <select v-model="selectedOption" @change="handleProcOperation(proc.id, false)">
                                <option value="0">-</option>
                                <option value="5">撤销</option>
                            </select>
                        </td>
                    </tr>
                </tbody>
            </table>
            <br> 
            </div>
        </div> 
        <hr>
        <br>
        <div v-for="item in staffTodos" :key="item.title">
            <h3>{{ item.title }}</h3>
            <br>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">居民档案号</th>
                        <th scope="col">姓名</th>
                        <th scope="col">服务项目</th>
                        <th v-if="item.title == '本周服务安排'" scope="col">计划时间</th>
                        <th scope="col">联系电话</th>
                        <th scope="col">家庭地址</th>
                        <th scope="col">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="todo in item.todos" :key="todo.id">
                        <td>{{ todo.customer_number }}</td>
                        <td><a :href="todo.state == 3 ? null : 'customer_service/' + todo.customer_id">{{ todo.customer_name }}</a></td>
                        <td :class="{'red': todo.completion_timeout}">{{ todo.service_label }}</td>
                        <td v-if="item.title == '本周服务安排'">{{ todo.scheduled_time }}</td>
                        <td>{{ todo.customer_phone }}</td>
                        <td>{{ todo.customer_address }}</td>
                        <td>
                            <select v-model="selectedOption" @change="handleProcOperation(todo.id, true)">
                                <option value="0">-</option>
                                <option value="1">修改</option>
                                <option value="3">{{ todo.state==3? '恢复' : '挂起'}}</option>
                                <option value="5">撤销</option>
                            </select>
                        </td>
                    </tr>
                </tbody>
            </table>
            <br>
            <hr>
            <br>
        </div>
    </div>
    {% endverbatim %}

    <script src="https://unpkg.com/vue@3"></script>
    <script>
        const { createApp } = Vue;

        // 获取当前日期（格式化为 "yy.mm.dd"）
        const today = new Date().toLocaleDateString('zh-CN', {
            year: '2-digit',
            month: '2-digit',
            day: '2-digit'
        }).replace(/\//g, '.');

        const customerServiceApp = {
            data() {
                return {
                    staffTodos: null,
                    unassignedProcs: [],
                    selectedOption: null,
                }
            },

            methods: {
                handleProcOperation(id, hasAssigned) {
                    // hasAssigned: true表示已分配任务，false表示未分配任务, 来自OperationProc
                    if (hasAssigned) {
                        if (this.selectedOption == '1') {
                            window.location.href = 'rollback_task/' + id;
                        } else if (this.selectedOption == '3') {
                            window.location.href = 'suspend_or_resume_task/' + id;
                        } else if (this.selectedOption == '5') {
                            window.location.href = 'cancel_task/' + id;
                        }
                    } else {
                        if (this.selectedOption == '5') {
                            window.location.href = 'cancel_task/' + id;
                        }
                    }
                },
            },

            created() {
                let _this = this;
                var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws"

                // 建立信道：操作员任务列表
                const staffTodosListSocket = new WebSocket(`${ws_scheme}://${window.location.host}/ws/staff_todos_list/`);
                staffTodosListSocket.onmessage = function (event) {
                    _this.staffTodos = JSON.parse(event.data)
                };

                // 建立信道：未分配服务进程
                const unassignedProcsSocket = new WebSocket(`${ws_scheme}://${window.location.host}/ws/unassigned_procs/`);
                unassignedProcsSocket.onmessage = function (event) {
                    // 未分配服务进程unassignedProcs
                    _this.unassignedProcs = JSON.parse(event.data);
                };
            },
        };

        createApp(customerServiceApp).mount('#app');
    </script>

    <style type="text/css">
        .red{            
            color: red;
        }
    </style>

{% endblock %}