{% extends "admin/change_form.html" %}

{% block extrahead %}
{{ block.super }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 表单事件规则配置列表
        const rules = [{"boolfield_ji_bing_ming_cheng": ["非胰岛素依赖型糖尿病", "胰岛素依赖型糖尿病"], "boolfield_yao_pin_ming": ["5%葡萄糖氯化钠注射液", "10%葡萄糖(新）", "5%葡萄糖注射液(新）"], "form_event_action": "WARN"}, {"boolfield_ji_bing_ming_cheng": ["低血糖症"], "boolfield_yao_pin_ming": ["甘精胰岛素注射液", "门冬胰岛素50注射液"], "form_event_action": "PROHIBIT"}, {"boolfield_ji_bing_ming_cheng": ["肾盂肾炎", "肾小球性肾炎/肾病"], "boolfield_yao_pin_ming": ["格华止片(盐酸二甲双胍片)", "圣邦杰（盐酸二甲双胍片）"], "form_event_action": "WARN"}]

        // 定义全局变量，用于存储被跟踪的字段当前值
        const current_values = {
            boolfield_ji_bing_ming_cheng: null,
            boolfield_yao_pin_ming: null
        }

        // 定义表单事件动作，接受一个选项，来自表单事件规则列表
        const form_event_action = (action, conflict_items) => {
            // 把冲突项目数组转换为字符串
            const conflict_items_string = conflict_items.join('、');
            if (action === 'WARN') {
                // 警告用户内容冲突
                alert(`表单内容冲突：${conflict_items_string}`);
            } else if (action === 'PROHIBIT') {
                alert(`表单内容冲突：${conflict_items_string}`);
                // 禁止保存表单
                document.querySelector('input[name="_save"]').disabled = true;
            }
        }

        // 检测是否发生符合特定规则的表单事件. 接受一条来自表单事件规则列表的规则, 如果发生表单事件，执行规则配置表中指定的表单事件动作
        const detect_form_event = (rule) => {
            const events = {
                event_0 : new Set(rule.boolfield_ji_bing_ming_cheng).has(current_values.boolfield_ji_bing_ming_cheng),
                event_1 : current_values.boolfield_yao_pin_ming.filter(item => rule.boolfield_yao_pin_ming.includes(item)).length > 0,
            }
            // 相与所有事件结果，如果全部为真，返回真
            if (Object.values(events).every(value => value === true)) {
                // 构造冲突项列表
                const conflict_items = [];
                for (const key in current_values) {
                    const value = current_values[key];
                    // 如果值是数组，找出冲突项
                    if (Array.isArray(value)) {
                        const conflictingItems = value.filter(item => rule.boolfield_yao_pin_ming.includes(item));
                        if (conflictingItems.length > 0) {
                            conflict_items.push(conflictingItems.join(', '));
                        }
                    } else {
                        conflict_items.push(value);
                    }
                }                

                form_event_action(rule.form_event_action, conflict_items)
            }
        };

        // 选择字段对应的dom元素，django admin 自动补全单选下拉框，创建一个新的MutationObserver实例，监听变化。
        const boolfield_ji_bing_ming_cheng = document.querySelector('.form-row.field-boolfield_ji_bing_ming_cheng .related-widget-wrapper');
        // Create a new MutationObserver instance
        const observer_boolfield_ji_bing_ming_cheng = new MutationObserver(function(mutationsList, observer) {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    const spanElement = boolfield_ji_bing_ming_cheng.querySelector('span.select2-selection__rendered');
                    if (spanElement.hasAttribute('title')) {
                        const title = spanElement.getAttribute('title').trim();
                        // 检查字段内容是否发生变化
                        if (title !== current_values.boolfield_ji_bing_ming_cheng) {
                            current_values.boolfield_ji_bing_ming_cheng = title;
                            // 检查保存按钮是否被禁用，如果是，启用
                            document.querySelector('input[name="_save"]').disabled = false;
                            // 如果疾病名称在规则列表中，检查表单事件
                            rules.find(item => {
                                if (item.boolfield_ji_bing_ming_cheng.includes(current_values.boolfield_ji_bing_ming_cheng)) {
                                    detect_form_event(item);
                                }
                            });
                        }
                    }            
                }
            }
        });
        observer_boolfield_ji_bing_ming_cheng.observe(boolfield_ji_bing_ming_cheng, { childList: true, subtree: true });

        // 选择字段对应的dom元素，django admin 自动补全多选下拉框，创建一个新的MutationObserver实例，监听变化。
        const boolfield_yao_pin_ming = document.querySelector('.form-row.field-boolfield_yao_pin_ming .related-widget-wrapper');
        // Create a new MutationObserver instance
        const observer_boolfield_yao_pin_ming = new MutationObserver(function(mutationsList, observer) {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    const spanElement = boolfield_yao_pin_ming.querySelector('ul.select2-selection__rendered');
                    const liElements = spanElement.querySelectorAll('li.select2-selection__choice');
                    const titleArray = Array.from(liElements, li => li.getAttribute('title').trim());
                    // 检查字段内容是否发生变化
                    if (JSON.stringify(titleArray) !== JSON.stringify(current_values.boolfield_yao_pin_ming)) {
                        current_values.boolfield_yao_pin_ming = titleArray;
                        // 检查保存按钮是否被禁用，如果是，启用
                        document.querySelector('input[name="_save"]').disabled = false;
                        // 如果药品名称在规则列表中，检查表单事件
                        rules.find(item => {
                            if (item.boolfield_yao_pin_ming.filter(item => current_values.boolfield_yao_pin_ming.includes(item)).length > 0) {
                                detect_form_event(item);
                            }
                        });
                    }
                }
            }
        });
        observer_boolfield_yao_pin_ming.observe(boolfield_yao_pin_ming, { childList: true, subtree: true });
    });
</script>

{% endblock %}